<div class="comunicacao-container"
     [class.dark-mode]="modoEscuro()"
     [class.alto-contraste]="modoAltoContraste()">

  <!-- ===================================== -->
  <!-- HEADER COM T√çTULO E A√á√ïES -->
  <!-- ===================================== -->
  <header class="app-header">
    <div class="header-content">
      <h1 class="app-title">
        <span class="app-icon">üó£Ô∏è</span>
        VOX Comunica√ß√£o
      </h1>

      <div class="header-actions">
        <button class="icon-btn" title="Pictogramas mais usados" (click)="toggleMaisUsados()">
          ‚≠ê
        </button>
        <button class="icon-btn" title="Configura√ß√µes" (click)="abrirConfiguracoes()">
          ‚öôÔ∏è
        </button>
        <button class="icon-btn" title="Hist√≥rico" (click)="abrirHistorico()">
          üìã
        </button>
      </div>
    </div>
  </header>

  <!-- ===================================== -->
  <!-- BARRA DE MENSAGEM (CONSTRU√á√ÉO) -->
  <!-- ===================================== -->
  <section class="mensagem-bar">
    <div class="mensagem-content">

      <!-- Pictogramas selecionados -->
      <div class="pictogramas-selecionados" #phraseContent>
        @if (pictogramasSelecionados().length === 0) {
          <div class="placeholder-texto">
            Selecione pictogramas para formar sua mensagem...
          </div>
        }

        @for (item of pictogramasSelecionados(); track item.timestamp) {
          <div class="picto-selecionado"
               (click)="removerPictogramaPorIndex($index)"
               title="Clique para remover">

            <!-- Verifica se tem URL de imagem ou usa emoji -->
            @if (item.pictograma.imagemUrl) {
              <img [src]="item.pictograma.imagemUrl"
                   [alt]="item.pictograma.label"
                   class="picto-imagem">
            } @else {
              <span class="picto-emoji">{{ item.pictograma.icone || 'üì∑' }}</span>
            }

            <span class="picto-label-small">{{ item.pictograma.label }}</span>
            <span class="picto-remove">‚úï</span>
          </div>
        }
      </div>

      <!-- Texto completo da mensagem -->
      @if (textoCompleto()) {
        <div class="texto-completo">
          <strong>üìù</strong> {{ textoCompleto() }}
        </div>
      }
    </div>

    <!-- Bot√µes de a√ß√£o -->
    <div class="mensagem-actions">
      <button class="btn-action btn-voltar"
              (click)="removerUltimoPictograma()"
              [disabled]="pictogramasSelecionados().length === 0"
              title="Remover √∫ltimo">
        ‚Ü∂
      </button>

      <button class="btn-action btn-limpar"
              (click)="limparSelecao()"
              [disabled]="pictogramasSelecionados().length === 0"
              title="Limpar tudo">
        üóëÔ∏è
      </button>

      <button class="btn-action btn-salvar"
              (click)="salvarMensagem()"
              [disabled]="pictogramasSelecionados().length === 0"
              title="Salvar no hist√≥rico">
        üíæ
      </button>

      <button class="btn-falar"
              (click)="falarMensagem()"
              [disabled]="pictogramasSelecionados().length === 0">
        <span class="btn-icon">üîä</span>
        <span class="btn-text">Falar</span>
      </button>
    </div>
  </section>

  <!-- ===================================== -->
  <!-- √ÅREA PRINCIPAL (CATEGORIAS + PICTOGRAMAS) -->
  <!-- ===================================== -->
  <div class="main-area">

    <!-- SIDEBAR DE CATEGORIAS -->
    <aside class="categorias-sidebar">
      <div class="categorias-scroll">
        @for (categoria of categorias(); track categoria.id) {
          <button
            class="categoria-btn"
            [class.active]="categoriaSelecionada()?.id === categoria.id"
            [style.--categoria-cor]="categoria.cor"
            (click)="selecionarCategoria(categoria)"
            [title]="categoria.nome">

            <span class="categoria-icon">{{ categoria.icone || 'üìÅ' }}</span>
            <span class="categoria-nome">{{ categoria.nome }}</span>

            @if (categoria.icone) {
              <span class="badge-personalizado">‚òÖ</span>
            }
          </button>
        }

        <!-- Bot√£o adicionar categoria -->
        <button class="categoria-btn btn-add"
                (click)="adicionarCategoria()"
                title="Adicionar categoria">
          <span class="categoria-icon">‚ûï</span>
          <span class="categoria-nome">Nova</span>
        </button>
      </div>
    </aside>

    <!-- GRID DE PICTOGRAMAS -->
    <section class="pictogramas-area">

      <!-- T√≠tulo da categoria selecionada -->
      @if (categoriaSelecionada()) {
        <div class="categoria-header">
          <h2 class="categoria-titulo">
            <span>{{ categoriaSelecionada()?.icone }}</span>
            {{ categoriaSelecionada()?.nome }}
          </h2>

          <div class="categoria-info">
            <span class="pictograma-count">
              {{ pictogramas().length }} pictogramas
            </span>
          </div>
        </div>
      }

      <!-- Grid de pictogramas -->
      <div class="pictogramas-grid" [attr.data-tamanho]="configuracao()?.tamanhoPictograma || 'medio'">

        @if (loading()) {
          <!-- Loading state -->
          <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Carregando pictogramas...</p>
          </div>
        }

        @if (!loading() && pictogramas().length === 0) {
          <!-- Empty state -->
          <div class="empty-state">
            <span class="empty-icon">üì≠</span>
            <h3>Nenhum pictograma encontrado</h3>
            <p>Adicione pictogramas a esta categoria ou selecione outra.</p>
          </div>
        }

        @for (picto of pictogramas(); track picto.id) {
          <button
            class="pictograma-card"
            (click)="selecionarPictograma(picto)"
            [class.frequente]="picto.vezesUsado && picto.vezesUsado > 10"
            [title]="picto.label + (picto.labelAlternativo ? ' (' + picto.labelAlternativo + ')' : '')">

            <!-- Imagem ou emoji -->
            <div class="picto-visual">
              @if (picto.imagemUrl) {
                <img [src]="picto.imagemUrl"
                     [alt]="picto.label"
                     class="picto-img"
                     loading="lazy">
              } @else {
                <span class="picto-emoji-large">{{ picto.icone || 'üì∑' }}</span>
              }
            </div>

            <!-- Label -->
            <div class="picto-info">
              <span class="picto-label">{{ picto.label }}</span>

              @if (picto.labelAlternativo) {
                <span class="picto-alt">{{ picto.labelAlternativo }}</span>
              }
            </div>

            <!-- Badge de uso frequente -->
            @if (picto.vezesUsado && picto.vezesUsado > 10) {
              <span class="badge-frequente" [title]="'Usado ' + picto.vezesUsado + ' vezes'">
                üî•
              </span>
            }

            <!-- Badge padr√£o -->
            @if (picto.padrao) {
              <span class="badge-padrao">‚≠ê</span>
            }
          </button>
        }
      </div>

      <!-- Bot√£o adicionar pictograma -->
      @if (!loading() && categoriaSelecionada()) {
        <button class="btn-add-pictograma" (click)="adicionarPictograma()">
          <span>‚ûï</span>
          Adicionar pictograma personalizado
        </button>
      }
    </section>
  </div>

  <!-- ===================================== -->
  <!-- PAINEL DE PICTOGRAMAS MAIS USADOS -->
  <!-- ===================================== -->
  @if (mostrarMaisUsados()) {
    <aside class="painel-mais-usados">
      <div class="painel-header">
        <h3>‚≠ê Mais Usados</h3>
        <button class="btn-fechar" (click)="toggleMaisUsados()">‚úï</button>
      </div>

      <div class="mais-usados-grid">
        @for (picto of pictogramasMaisUsados(); track picto.id) {
          <button class="picto-mini"
                  (click)="selecionarPictograma(picto)"
                  [title]="picto.label">
            @if (picto.imagemUrl) {
              <img [src]="picto.imagemUrl" [alt]="picto.label">
            } @else {
              <span>{{ picto.icone || 'üì∑' }}</span>
            }
            <span class="picto-mini-label">{{ picto.label }}</span>
          </button>
        }
      </div>
    </aside>
  }

  <!-- ===================================== -->
  <!-- ALERTAS E NOTIFICA√á√ïES -->
  <!-- ===================================== -->
  @if (error()) {
    <div class="alert alert-error" (click)="error.set(null)">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <span class="alert-message">{{ error() }}</span>
      <button class="alert-close">‚úï</button>
    </div>
  }

  @if (sucessoMensagem()) {
    <div class="alert alert-success" (click)="sucessoMensagem.set(null)">
      <span class="alert-icon">‚úÖ</span>
      <span class="alert-message">{{ sucessoMensagem() }}</span>
      <button class="alert-close">‚úï</button>
    </div>
  }
</div>
